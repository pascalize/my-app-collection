<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…è¡Œãƒ—ãƒ©ãƒ³ãƒãƒƒãƒ—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        .app-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .input-panel {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .map-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 20px;
            position: relative;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .japan-map {
            width: 100%;
            height: 500px;
            position: relative;
            background: linear-gradient(45deg, #e8f4fd 0%, #bddbfa 100%);
            border-radius: 10px;
            overflow: hidden;
        }

        .prefecture {
            position: absolute;
            background-color: #fff;
            border: 2px solid #007bff;
            border-radius: 20px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .prefecture:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .prefecture.selected {
            background-color: #007bff;
            color: white;
        }

        .detailed-map {
            display: none;
            width: 100%;
            height: 500px;
            position: relative;
            background: #f0f8ff;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #007bff;
        }

        .detailed-map.active {
            display: block;
        }

        .city-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #ff4757;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .city-point:hover {
            transform: scale(1.5);
            z-index: 100;
        }

        .city-point.selected {
            background-color: #2ed573;
            transform: scale(1.3);
        }

        .city-label {
            position: absolute;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 10px;
            white-space: nowrap;
            transform: translate(-50%, -120%);
            pointer-events: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 200;
        }

        .map-controls button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .map-controls button:hover {
            background: #0056b3;
        }

        .route-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, #007bff, #28a745);
            z-index: 1;
            transform-origin: left center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .route-line::before {
            content: '';
            position: absolute;
            right: -8px;
            top: -3px;
            width: 0;
            height: 0;
            border-left: 8px solid #28a745;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }

        .clickable-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 0;
        }

        .location-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ff6b35;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .order-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .prefecture-shape {
            position: absolute;
            fill: rgba(200, 220, 255, 0.3);
            stroke: #007bff;
            stroke-width: 1.5;
            pointer-events: none;
        }

        .prefecture-shape.highlighted {
            fill: rgba(0, 123, 255, 0.5);
            stroke: #0056b3;
            stroke-width: 2;
        }

        .compact-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #ff6b6b;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            transition: all 0.3s;
        }

        .compact-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 100;
        }

        .info-popup {
            position: absolute;
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 12px;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 200;
            display: none;
            font-size: 12px;
        }

        .info-popup.show {
            display: block;
        }

        .info-popup h4 {
            margin: 0 0 8px 0;
            color: #007bff;
            font-size: 14px;
        }

        .info-popup p {
            margin: 4px 0;
            color: #333;
        }

        .popup-close {
            position: absolute;
            top: 5px;
            right: 8px;
            cursor: pointer;
            font-size: 16px;
            color: #999;
        }

        .popup-close:hover {
            color: #333;
        }

        .travel-marker {
            position: absolute;
            background: #ff6b6b;
            color: white;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            z-index: 5;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            min-width: 80px;
            text-align: center;
        }

        .travel-marker::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #ff6b6b;
        }

        .travel-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .travel-item {
            background: #f8f9fa;
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }

        .travel-item-header {
            font-weight: bold;
            color: #007bff;
        }

        .travel-item-details {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }

        @media (max-width: 768px) {
            .app-layout {
                grid-template-columns: 1fr;
            }
            
            .input-panel {
                order: 2;
            }
            
            .map-panel {
                order: 1;
                height: 400px;
            }
            
            .japan-map {
                height: 350px;
            }
        }

        .hokkaido { top: 20px; left: 80px; }
        .tohoku { top: 80px; left: 120px; }
        .kanto { top: 150px; left: 140px; }
        .chubu { top: 180px; left: 100px; }
        .kansai { top: 220px; left: 80px; }
        .chugoku { top: 240px; left: 50px; }
        .shikoku { top: 280px; left: 80px; }
        .kyushu { top: 320px; left: 30px; }
        .okinawa { top: 400px; left: 60px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ æ—…è¡Œãƒ—ãƒ©ãƒ³ãƒãƒƒãƒ—</h1>
        
        <div class="app-layout">
            <div class="input-panel">
                <form id="travelForm">
                    <div class="form-group">
                        <label for="region">åœ°æ–¹</label>
                        <select id="region" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="hokkaido">åŒ—æµ·é“</option>
                            <option value="tohoku">æ±åŒ—åœ°æ–¹</option>
                            <option value="kanto">é–¢æ±åœ°æ–¹</option>
                            <option value="chubu">ä¸­éƒ¨åœ°æ–¹</option>
                            <option value="kansai">é–¢è¥¿åœ°æ–¹</option>
                            <option value="chugoku">ä¸­å›½åœ°æ–¹</option>
                            <option value="shikoku">å››å›½åœ°æ–¹</option>
                            <option value="kyushu">ä¹å·åœ°æ–¹</option>
                            <option value="okinawa">æ²–ç¸„</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="prefecture">éƒ½é“åºœçœŒ</label>
                        <select id="prefecture" required>
                            <option value="">ã¾ãšåœ°æ–¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="specificLocation">å…·ä½“çš„ãªå ´æ‰€</label>
                        <input type="text" id="specificLocation" placeholder="åœ°å›³ä¸Šã§ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹ã€ç›´æ¥å…¥åŠ›">
                    </div>

                    <div class="form-group">
                        <label for="order">è¨ªå•é †åº</label>
                        <input type="number" id="order" min="1" placeholder="1, 2, 3...">
                    </div>

                    <div class="form-group">
                        <label for="startDate">é–‹å§‹æ—¥</label>
                        <input type="date" id="startDate" required>
                    </div>

                    <div class="form-group">
                        <label for="endDate">çµ‚äº†æ—¥</label>
                        <input type="date" id="endDate" required>
                    </div>

                    <div class="form-group">
                        <label for="budget">äºˆç®—ï¼ˆå††ï¼‰</label>
                        <input type="number" id="budget" min="0" placeholder="ä¾‹: 50000">
                    </div>

                    <div class="form-group">
                        <label for="transportation">äº¤é€šæ‰‹æ®µ</label>
                        <select id="transportation">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="train">é›»è»Šãƒ»æ–°å¹¹ç·š</option>
                            <option value="plane">é£›è¡Œæ©Ÿ</option>
                            <option value="car">è‡ªå‹•è»Š</option>
                            <option value="bus">ãƒã‚¹</option>
                            <option value="ferry">ãƒ•ã‚§ãƒªãƒ¼</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="activities">äºˆå®šãƒ»æ´»å‹•</label>
                        <textarea id="activities" placeholder="è¦³å…‰åœ°ã€ã‚¤ãƒ™ãƒ³ãƒˆã€é£Ÿäº‹ãªã©"></textarea>
                    </div>

                    <button type="submit" class="btn">åœ°å›³ã«è¿½åŠ </button>
                    <button type="button" class="btn btn-secondary" onclick="clearMap()">ãƒªã‚»ãƒƒãƒˆ</button>
                </form>

                <div class="travel-list" id="travelList">
                    <h3>æ—…è¡Œãƒ—ãƒ©ãƒ³ä¸€è¦§</h3>
                </div>
            </div>

            <div class="map-panel">
                <div class="japan-map" id="japanMap">
                    <div class="prefecture hokkaido" data-region="hokkaido">åŒ—æµ·é“</div>
                    <div class="prefecture tohoku" data-region="tohoku">æ±åŒ—</div>
                    <div class="prefecture kanto" data-region="kanto">é–¢æ±</div>
                    <div class="prefecture chubu" data-region="chubu">ä¸­éƒ¨</div>
                    <div class="prefecture kansai" data-region="kansai">é–¢è¥¿</div>
                    <div class="prefecture chugoku" data-region="chugoku">ä¸­å›½</div>
                    <div class="prefecture shikoku" data-region="shikoku">å››å›½</div>
                    <div class="prefecture kyushu" data-region="kyushu">ä¹å·</div>
                    <div class="prefecture okinawa" data-region="okinawa">æ²–ç¸„</div>
                </div>
                
                <div class="detailed-map" id="detailedMap">
                    <svg id="prefectureSvg" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;"></svg>
                    <div class="clickable-area" id="clickableArea"></div>
                    <div class="map-controls">
                        <button onclick="showJapanMap()">â† æ—¥æœ¬åœ°å›³ã«æˆ»ã‚‹</button>
                        <button onclick="toggleRoutes()" id="routeToggle">çµŒè·¯è¡¨ç¤º</button>
                        <button onclick="toggleShapes()" id="shapeToggle">å¢ƒç•Œç·šè¡¨ç¤º</button>
                    </div>
                    <div id="regionTitle" style="text-align: center; font-weight: bold; padding: 10px; font-size: 18px;"></div>
                    <div id="cityPoints"></div>
                    <div id="routeLines"></div>
                    <div id="locationMarkers"></div>
                    <div id="infoPopup" class="info-popup">
                        <span class="popup-close" onclick="hideInfoPopup()">Ã—</span>
                        <div id="popupContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let travelPlans = [];
        let planCounter = 0;
        let currentRegion = null;
        let showRoutes = true;
        let clickedLocation = null;
        let showShapes = true;

        const regionNames = {
            'hokkaido': 'åŒ—æµ·é“',
            'tohoku': 'æ±åŒ—åœ°æ–¹', 
            'kanto': 'é–¢æ±åœ°æ–¹',
            'chubu': 'ä¸­éƒ¨åœ°æ–¹',
            'kansai': 'é–¢è¥¿åœ°æ–¹',
            'chugoku': 'ä¸­å›½åœ°æ–¹',
            'shikoku': 'å››å›½åœ°æ–¹',
            'kyushu': 'ä¹å·åœ°æ–¹',
            'okinawa': 'æ²–ç¸„'
        };

        // ã‚ˆã‚Šè©³ç´°ãªéƒ½é“åºœçœŒå½¢çŠ¶ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®å¢ƒç•Œç·šã«è¿‘ã„å½¢çŠ¶ï¼‰
        const prefectureShapes = {
            'hokkaido': {
                'hokkaido': 'M 150,80 C 160,75 180,70 200,72 C 220,74 240,75 260,77 C 280,79 300,82 320,86 C 340,90 360,95 375,105 C 390,115 400,130 405,145 C 410,160 412,175 410,190 C 408,205 405,220 400,235 C 395,250 385,265 375,278 C 365,291 350,302 335,310 C 320,318 305,323 290,326 C 275,329 260,330 245,329 C 230,328 215,325 200,320 C 185,315 170,308 158,298 C 146,288 136,275 130,260 C 124,245 122,228 124,212 C 126,196 130,180 135,165 C 140,150 145,135 150,120 C 152,105 151,90 150,80 Z'
            },
            'tohoku': {
                'aomori': 'M 240,50 C 250,48 260,47 270,48 C 280,49 290,51 298,55 C 306,59 312,65 316,72 C 320,79 321,87 320,95 C 319,103 316,110 311,116 C 306,122 299,127 291,130 C 283,133 274,134 265,133 C 256,132 247,129 239,125 C 231,121 224,115 219,108 C 214,101 211,93 210,85 C 209,77 210,69 213,62 C 216,55 221,49 227,45 C 233,41 240,39 247,39 C 249,42 245,46 240,50 Z',
                'iwate': 'M 290,90 C 300,88 310,87 320,88 C 330,89 340,92 348,97 C 356,102 362,109 366,117 C 370,125 371,134 370,143 C 369,152 366,160 361,167 C 356,174 349,180 341,184 C 333,188 324,190 315,190 C 306,190 297,188 289,184 C 281,180 274,174 269,167 C 264,160 261,152 260,143 C 259,134 260,125 263,117 C 266,109 271,102 277,96 C 283,90 290,86 298,84 C 295,86 292,88 290,90 Z',
                'miyagi': 'M 270,150 C 280,148 290,147 300,148 C 310,149 320,152 328,157 C 336,162 342,169 346,177 C 350,185 351,194 350,203 C 349,212 346,220 341,227 C 336,234 329,240 321,244 C 313,248 304,250 295,250 C 286,250 277,248 269,244 C 261,240 254,234 249,227 C 244,220 241,212 240,203 C 239,194 240,185 243,177 C 246,169 251,162 257,156 C 263,150 270,146 278,144 C 275,146 272,148 270,150 Z',
                'akita': 'M 210,100 C 220,98 230,97 240,98 C 250,99 260,102 268,107 C 276,112 282,119 286,127 C 290,135 291,144 290,153 C 289,162 286,170 281,177 C 276,184 269,190 261,194 C 253,198 244,200 235,200 C 226,200 217,198 209,194 C 201,190 194,184 189,177 C 184,170 181,162 180,153 C 179,144 180,135 183,127 C 186,119 191,112 197,106 C 203,100 210,96 218,94 C 215,96 212,98 210,100 Z',
                'yamagata': 'M 220,170 C 230,168 240,167 250,168 C 260,169 270,172 278,177 C 286,182 292,189 296,197 C 300,205 301,214 300,223 C 299,232 296,240 291,247 C 286,254 279,260 271,264 C 263,268 254,270 245,270 C 236,270 227,268 219,264 C 211,260 204,254 199,247 C 194,240 191,232 190,223 C 189,214 190,205 193,197 C 196,189 201,182 207,176 C 213,170 220,166 228,164 C 225,166 222,168 220,170 Z',
                'fukushima': 'M 270,220 C 280,218 290,217 300,218 C 310,219 320,222 328,227 C 336,232 342,239 346,247 C 350,255 351,264 350,273 C 349,282 346,290 341,297 C 336,304 329,310 321,314 C 313,318 304,320 295,320 C 286,320 277,318 269,314 C 261,310 254,304 249,297 C 244,290 241,282 240,273 C 239,264 240,255 243,247 C 246,239 251,232 257,226 C 263,220 270,216 278,214 C 275,216 272,218 270,220 Z'
            },
            'kanto': {
                'ibaraki': 'M 310,240 C 320,238 330,237 340,238 C 350,239 360,242 368,247 C 376,252 382,259 386,267 C 390,275 391,284 390,293 C 389,302 386,310 381,317 C 376,324 369,330 361,334 C 353,338 344,340 335,340 C 326,340 317,338 309,334 C 301,330 294,324 289,317 C 284,310 281,302 280,293 C 279,284 280,275 283,267 C 286,259 291,252 297,246 C 303,240 310,236 318,234 C 315,236 312,238 310,240 Z',
                'tochigi': 'M 270,220 C 280,218 290,217 300,218 C 310,219 320,222 328,227 C 336,232 342,239 346,247 C 350,255 351,264 350,273 C 349,282 346,290 341,297 C 336,304 329,310 321,314 C 313,318 304,320 295,320 C 286,320 277,318 269,314 C 261,310 254,304 249,297 C 244,290 241,282 240,273 C 239,264 240,255 243,247 C 246,239 251,232 257,226 C 263,220 270,216 278,214 C 275,216 272,218 270,220 Z',
                'gunma': 'M 230,230 C 240,228 250,227 260,228 C 270,229 280,232 288,237 C 296,242 302,249 306,257 C 310,265 311,274 310,283 C 309,292 306,300 301,307 C 296,314 289,320 281,324 C 273,328 264,330 255,330 C 246,330 237,328 229,324 C 221,320 214,314 209,307 C 204,300 201,292 200,283 C 199,274 200,265 203,257 C 206,249 211,242 217,236 C 223,230 230,226 238,224 C 235,226 232,228 230,230 Z',
                'saitama': 'M 250,260 C 260,258 270,257 280,258 C 290,259 300,262 308,267 C 316,272 322,279 326,287 C 330,295 331,304 330,313 C 329,322 326,330 321,337 C 316,344 309,350 301,354 C 293,358 284,360 275,360 C 266,360 257,358 249,354 C 241,350 234,344 229,337 C 224,330 221,322 220,313 C 219,304 220,295 223,287 C 226,279 231,272 237,266 C 243,260 250,256 258,254 C 255,256 252,258 250,260 Z',
                'chiba': 'M 310,280 C 320,278 330,277 340,278 C 350,279 360,282 368,287 C 376,292 382,299 386,307 C 390,315 391,324 390,333 C 389,342 386,350 381,357 C 376,364 369,370 361,374 C 353,378 344,380 335,380 C 326,380 317,378 309,374 C 301,370 294,364 289,357 C 284,350 281,342 280,333 C 279,324 280,315 283,307 C 286,299 291,292 297,286 C 303,280 310,276 318,274 C 315,276 312,278 310,280 Z',
                'tokyo': 'M 270,290 C 280,288 290,287 300,288 C 310,289 320,292 328,297 C 336,302 342,309 346,317 C 350,325 351,334 350,343 C 349,352 346,360 341,367 C 336,374 329,380 321,384 C 313,388 304,390 295,390 C 286,390 277,388 269,384 C 261,380 254,374 249,367 C 244,360 241,352 240,343 C 239,334 240,325 243,317 C 246,309 251,302 257,296 C 263,290 270,286 278,284 C 275,286 272,288 270,290 Z',
                'kanagawa': 'M 260,330 C 270,328 280,327 290,328 C 300,329 310,332 318,337 C 326,342 332,349 336,357 C 340,365 341,374 340,383 C 339,392 336,400 331,407 C 326,414 319,420 311,424 C 303,428 294,430 285,430 C 276,430 267,428 259,424 C 251,420 244,414 239,407 C 234,400 231,392 230,383 C 229,374 230,365 233,357 C 236,349 241,342 247,336 C 253,330 260,326 268,324 C 265,326 262,328 260,330 Z'
            },
            'chubu': {
                'niigata': 'M 210,100 C 220,95 235,92 250,95 C 265,98 275,105 280,115 C 285,125 285,137 280,148 C 275,159 265,168 250,172 C 235,176 220,175 210,170 C 200,165 195,155 195,143 C 195,131 200,118 210,108 C 215,103 212,101 210,100 Z',
                'toyama': 'M 190,140 C 200,135 215,132 230,135 C 245,138 255,145 260,155 C 265,165 265,177 260,188 C 255,199 245,208 230,212 C 215,216 200,215 190,210 C 180,205 175,195 175,183 C 175,171 180,158 190,148 C 195,143 192,141 190,140 Z',
                'ishikawa': 'M 170,150 C 180,145 195,142 210,145 C 225,148 235,155 240,165 C 245,175 245,187 240,198 C 235,209 225,218 210,222 C 195,226 180,225 170,220 C 160,215 155,205 155,193 C 155,181 160,168 170,158 C 175,153 172,151 170,150 Z',
                'fukui': 'M 150,180 C 160,175 175,172 190,175 C 205,178 215,185 220,195 C 225,205 225,217 220,228 C 215,239 205,248 190,252 C 175,256 160,255 150,250 C 140,245 135,235 135,223 C 135,211 140,198 150,188 C 155,183 152,181 150,180 Z',
                'yamanashi': 'M 250,200 C 260,195 275,192 290,195 C 305,198 315,205 320,215 C 325,225 325,237 320,248 C 315,259 305,268 290,272 C 275,276 260,275 250,270 C 240,265 235,255 235,243 C 235,231 240,218 250,208 C 255,203 252,201 250,200 Z',
                'nagano': 'M 220,170 C 230,165 245,162 260,165 C 275,168 285,175 290,185 C 295,195 295,207 290,218 C 285,229 275,238 260,242 C 245,246 230,245 220,240 C 210,235 205,225 205,213 C 205,201 210,188 220,178 C 225,173 222,171 220,170 Z',
                'gifu': 'M 200,200 C 210,195 225,192 240,195 C 255,198 265,205 270,215 C 275,225 275,237 270,248 C 265,259 255,268 240,272 C 225,276 210,275 200,270 C 190,265 185,255 185,243 C 185,231 190,218 200,208 C 205,203 202,201 200,200 Z',
                'shizuoka': 'M 270,240 C 280,235 295,232 310,235 C 325,238 335,245 340,255 C 345,265 345,277 340,288 C 335,299 325,308 310,312 C 295,316 280,315 270,310 C 260,305 255,295 255,283 C 255,271 260,258 270,248 C 275,243 272,241 270,240 Z',
                'aichi': 'M 240,220 C 250,215 265,212 280,215 C 295,218 305,225 310,235 C 315,245 315,257 310,268 C 305,279 295,288 280,292 C 265,296 250,295 240,290 C 230,285 225,275 225,263 C 225,251 230,238 240,228 C 245,223 242,221 240,220 Z'
            },
            'kansai': {
                'mie': 'M 230,240 C 240,235 255,232 270,235 C 285,238 295,245 300,255 C 305,265 305,277 300,288 C 295,299 285,308 270,312 C 255,316 240,315 230,310 C 220,305 215,295 215,283 C 215,271 220,258 230,248 C 235,243 232,241 230,240 Z',
                'shiga': 'M 200,210 C 210,205 225,202 240,205 C 255,208 265,215 270,225 C 275,235 275,247 270,258 C 265,269 255,278 240,282 C 225,286 210,285 200,280 C 190,275 185,265 185,253 C 185,241 190,228 200,218 C 205,213 202,211 200,210 Z',
                'kyoto': 'M 200,200 C 210,195 225,192 240,195 C 255,198 265,205 270,215 C 275,225 275,237 270,248 C 265,259 255,268 240,272 C 225,276 210,275 200,270 C 190,265 185,255 185,243 C 185,231 190,218 200,208 C 205,203 202,201 200,200 Z',
                'osaka': 'M 180,230 C 190,225 205,222 220,225 C 235,228 245,235 250,245 C 255,255 255,267 250,278 C 245,289 235,298 220,302 C 205,306 190,305 180,300 C 170,295 165,285 165,273 C 165,261 170,248 180,238 C 185,233 182,231 180,230 Z',
                'hyogo': 'M 160,220 C 170,215 185,212 200,215 C 215,218 225,225 230,235 C 235,245 235,257 230,268 C 225,279 215,288 200,292 C 185,296 170,295 160,290 C 150,285 145,275 145,263 C 145,251 150,238 160,228 C 165,223 162,221 160,220 Z',
                'nara': 'M 200,250 C 210,245 225,242 240,245 C 255,248 265,255 270,265 C 275,275 275,287 270,298 C 265,309 255,318 240,322 C 225,326 210,325 200,320 C 190,315 185,305 185,293 C 185,281 190,268 200,258 C 205,253 202,251 200,250 Z',
                'wakayama': 'M 170,280 C 180,275 195,272 210,275 C 225,278 235,285 240,295 C 245,305 245,317 240,328 C 235,339 225,348 210,352 C 195,356 180,355 170,350 C 160,345 155,335 155,323 C 155,311 160,298 170,288 C 175,283 172,281 170,280 Z'
            },
            'chugoku': {
                'tottori': 'M 250,140 C 260,135 275,132 290,135 C 305,138 315,145 320,155 C 325,165 325,177 320,188 C 315,199 305,208 290,212 C 275,216 260,215 250,210 C 240,205 235,195 235,183 C 235,171 240,158 250,148 C 255,143 252,141 250,140 Z',
                'shimane': 'M 210,150 C 220,145 235,142 250,145 C 265,148 275,155 280,165 C 285,175 285,187 280,198 C 275,209 265,218 250,222 C 235,226 220,225 210,220 C 200,215 195,205 195,193 C 195,181 200,168 210,158 C 215,153 212,151 210,150 Z',
                'okayama': 'M 230,180 C 240,175 255,172 270,175 C 285,178 295,185 300,195 C 305,205 305,217 300,228 C 295,239 285,248 270,252 C 255,256 240,255 230,250 C 220,245 215,235 215,223 C 215,211 220,198 230,188 C 235,183 232,181 230,180 Z',
                'hiroshima': 'M 190,200 C 200,195 215,192 230,195 C 245,198 255,205 260,215 C 265,225 265,237 260,248 C 255,259 245,268 230,272 C 215,276 200,275 190,270 C 180,265 175,255 175,243 C 175,231 180,218 190,208 C 195,203 192,201 190,200 Z',
                'yamaguchi': 'M 110,220 C 120,215 135,212 150,215 C 165,218 175,225 180,235 C 185,245 185,257 180,268 C 175,279 165,288 150,292 C 135,296 120,295 110,290 C 100,285 95,275 95,263 C 95,251 100,238 110,228 C 115,223 112,221 110,220 Z'
            },
            'shikoku': {
                'tokushima': 'M 270,230 C 280,225 295,222 310,225 C 325,228 335,235 340,245 C 345,255 345,267 340,278 C 335,289 325,298 310,302 C 295,306 280,305 270,300 C 260,295 255,285 255,273 C 255,261 260,248 270,238 C 275,233 272,231 270,230 Z',
                'kagawa': 'M 230,210 C 240,205 255,202 270,205 C 285,208 295,215 300,225 C 305,235 305,247 300,258 C 295,269 285,278 270,282 C 255,286 240,285 230,280 C 220,275 215,265 215,253 C 215,241 220,228 230,218 C 235,213 232,211 230,210 Z',
                'ehime': 'M 170,230 C 180,225 195,222 210,225 C 225,228 235,235 240,245 C 245,255 245,267 240,278 C 235,289 225,298 210,302 C 195,306 180,305 170,300 C 160,295 155,285 155,273 C 155,261 160,248 170,238 C 175,233 172,231 170,230 Z',
                'kochi': 'M 210,270 C 220,265 235,262 250,265 C 265,268 275,275 280,285 C 285,295 285,307 280,318 C 275,329 265,338 250,342 C 235,346 220,345 210,340 C 200,335 195,325 195,313 C 195,301 200,288 210,278 C 215,273 212,271 210,270 Z'
            },
            'kyushu': {
                'fukuoka': 'M 190,100 C 200,95 215,92 230,95 C 245,98 255,105 260,115 C 265,125 265,137 260,148 C 255,159 245,168 230,172 C 215,176 200,175 190,170 C 180,165 175,155 175,143 C 175,131 180,118 190,108 C 195,103 192,101 190,100 Z',
                'saga': 'M 160,120 C 170,115 185,112 200,115 C 215,118 225,125 230,135 C 235,145 235,157 230,168 C 225,179 215,188 200,192 C 185,196 170,195 160,190 C 150,185 145,175 145,163 C 145,151 150,138 160,128 C 165,123 162,121 160,120 Z',
                'nagasaki': 'M 110,140 C 120,135 135,132 150,135 C 165,138 175,145 180,155 C 185,165 185,177 180,188 C 175,199 165,208 150,212 C 135,216 120,215 110,210 C 100,205 95,195 95,183 C 95,171 100,158 110,148 C 115,143 112,141 110,140 Z',
                'kumamoto': 'M 170,180 C 180,175 195,172 210,175 C 225,178 235,185 240,195 C 245,205 245,217 240,228 C 235,239 225,248 210,252 C 195,256 180,255 170,250 C 160,245 155,235 155,223 C 155,211 160,198 170,188 C 175,183 172,181 170,180 Z',
                'oita': 'M 230,150 C 240,145 255,142 270,145 C 285,148 295,155 300,165 C 305,175 305,187 300,198 C 295,209 285,218 270,222 C 255,226 240,225 230,220 C 220,215 215,205 215,193 C 215,181 220,168 230,158 C 235,153 232,151 230,150 Z',
                'miyazaki': 'M 210,220 C 220,215 235,212 250,215 C 265,218 275,225 280,235 C 285,245 285,257 280,268 C 275,279 265,288 250,292 C 235,296 220,295 210,290 C 200,285 195,275 195,263 C 195,251 200,238 210,228 C 215,223 212,221 210,220 Z',
                'kagoshima': 'M 170,270 C 180,265 195,262 210,265 C 225,268 235,275 240,285 C 245,295 245,307 240,318 C 235,329 225,338 210,342 C 195,346 180,345 170,340 C 160,335 155,325 155,313 C 155,301 160,288 170,278 C 175,273 172,271 170,270 Z'
            },
            'okinawa': {
                'okinawa': 'M 240,190 C 250,185 265,182 280,185 C 295,188 305,195 310,205 C 315,215 315,227 310,238 C 305,249 295,258 280,262 C 265,266 250,265 240,260 C 230,255 225,245 225,233 C 225,221 230,208 240,198 C 245,193 242,191 240,190 Z'
            }
        };

        const prefectureData = {
            'hokkaido': [
                {name: 'åŒ—æµ·é“', x: 250, y: 200, isMain: true}
            ],
            'tohoku': [
                {name: 'é’æ£®çœŒ', x: 250, y: 80},
                {name: 'å²©æ‰‹çœŒ', x: 300, y: 120},
                {name: 'å®®åŸçœŒ', x: 280, y: 160},
                {name: 'ç§‹ç”°çœŒ', x: 220, y: 130},
                {name: 'å±±å½¢çœŒ', x: 230, y: 180},
                {name: 'ç¦å³¶çœŒ', x: 280, y: 220}
            ],
            'kanto': [
                {name: 'èŒ¨åŸçœŒ', x: 320, y: 160},
                {name: 'æ ƒæœ¨çœŒ', x: 280, y: 140},
                {name: 'ç¾¤é¦¬çœŒ', x: 240, y: 150},
                {name: 'åŸ¼ç‰çœŒ', x: 260, y: 170},
                {name: 'åƒè‘‰çœŒ', x: 320, y: 190},
                {name: 'æ±äº¬éƒ½', x: 280, y: 190},
                {name: 'ç¥å¥ˆå·çœŒ', x: 270, y: 220}
            ],
            'chubu': [
                {name: 'æ–°æ½ŸçœŒ', x: 220, y: 100},
                {name: 'å¯Œå±±çœŒ', x: 200, y: 140},
                {name: 'çŸ³å·çœŒ', x: 180, y: 150},
                {name: 'ç¦äº•çœŒ', x: 160, y: 170},
                {name: 'å±±æ¢¨çœŒ', x: 260, y: 160},
                {name: 'é•·é‡çœŒ', x: 230, y: 140},
                {name: 'å²é˜œçœŒ', x: 210, y: 180},
                {name: 'é™å²¡çœŒ', x: 280, y: 200},
                {name: 'æ„›çŸ¥çœŒ', x: 250, y: 190}
            ],
            'kansai': [
                {name: 'ä¸‰é‡çœŒ', x: 240, y: 200},
                {name: 'æ»‹è³€çœŒ', x: 210, y: 170},
                {name: 'äº¬éƒ½åºœ', x: 210, y: 160},
                {name: 'å¤§é˜ªåºœ', x: 190, y: 190},
                {name: 'å…µåº«çœŒ', x: 170, y: 190},
                {name: 'å¥ˆè‰¯çœŒ', x: 210, y: 210},
                {name: 'å’Œæ­Œå±±çœŒ', x: 180, y: 230}
            ],
            'chugoku': [
                {name: 'é³¥å–çœŒ', x: 260, y: 140},
                {name: 'å³¶æ ¹çœŒ', x: 220, y: 150},
                {name: 'å²¡å±±çœŒ', x: 240, y: 170},
                {name: 'åºƒå³¶çœŒ', x: 200, y: 190},
                {name: 'å±±å£çœŒ', x: 120, y: 210}
            ],
            'shikoku': [
                {name: 'å¾³å³¶çœŒ', x: 280, y: 200},
                {name: 'é¦™å·çœŒ', x: 240, y: 170},
                {name: 'æ„›åª›çœŒ', x: 180, y: 190},
                {name: 'é«˜çŸ¥çœŒ', x: 220, y: 240}
            ],
            'kyushu': [
                {name: 'ç¦å²¡çœŒ', x: 200, y: 110},
                {name: 'ä½è³€çœŒ', x: 170, y: 130},
                {name: 'é•·å´çœŒ', x: 120, y: 150},
                {name: 'ç†Šæœ¬çœŒ', x: 180, y: 190},
                {name: 'å¤§åˆ†çœŒ', x: 240, y: 150},
                {name: 'å®®å´çœŒ', x: 220, y: 210},
                {name: 'é¹¿å…å³¶çœŒ', x: 180, y: 260}
            ],
            'okinawa': [
                {name: 'æ²–ç¸„çœŒ', x: 250, y: 200, isMain: true}
            ]
        };

        const transportationNames = {
            'train': 'ğŸš… é›»è»Šãƒ»æ–°å¹¹ç·š',
            'plane': 'âœˆï¸ é£›è¡Œæ©Ÿ',
            'car': 'ğŸš— è‡ªå‹•è»Š',
            'bus': 'ğŸšŒ ãƒã‚¹',
            'ferry': 'ğŸš¢ ãƒ•ã‚§ãƒªãƒ¼'
        };

        // é–‹å§‹æ—¥ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰çµ‚äº†æ—¥ã‚’åŒã˜æ—¥ä»˜ã«è¨­å®š
        document.getElementById('startDate').addEventListener('change', function() {
            const startDate = this.value;
            if (startDate) {
                document.getElementById('endDate').value = startDate;
            }
        });

        document.getElementById('region').addEventListener('change', function() {
            const selectedRegion = this.value;
            const prefectureSelect = document.getElementById('prefecture');
            
            prefectureSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            
            if (selectedRegion && prefectureData[selectedRegion]) {
                prefectureData[selectedRegion].forEach(pref => {
                    const option = document.createElement('option');
                    option.value = pref.name;
                    option.textContent = pref.name;
                    prefectureSelect.appendChild(option);
                });
                
                showDetailedMap(selectedRegion);
            } else {
                showJapanMap();
            }
        });

        document.getElementById('travelForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const region = document.getElementById('region').value;
            const prefecture = document.getElementById('prefecture').value;
            const specificLocation = document.getElementById('specificLocation').value;
            const order = parseInt(document.getElementById('order').value) || (travelPlans.length + 1);
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const budget = document.getElementById('budget').value;
            const transportation = document.getElementById('transportation').value;
            const activities = document.getElementById('activities').value;

            if (!region || !prefecture || !startDate || !endDate) {
                alert('åœ°æ–¹ã€éƒ½é“åºœçœŒã€é–‹å§‹æ—¥ã€çµ‚äº†æ—¥ã¯å¿…é ˆé …ç›®ã§ã™');
                return;
            }

            const plan = {
                id: ++planCounter,
                region: region,
                prefecture: prefecture,
                specificLocation: specificLocation,
                order: order,
                startDate: startDate,
                endDate: endDate,
                budget: budget,
                transportation: transportation,
                activities: activities,
                customLocation: clickedLocation ? { x: clickedLocation.x, y: clickedLocation.y } : null
            };
            
            clickedLocation = null;

            travelPlans.push(plan);
            updateMap();
            updateTravelList();
            document.getElementById('travelForm').reset();
            document.getElementById('prefecture').innerHTML = '<option value="">ã¾ãšåœ°æ–¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            document.getElementById('specificLocation').value = '';
        });

        function updateMap() {
            document.querySelectorAll('.travel-marker').forEach(marker => marker.remove());
            document.querySelectorAll('.prefecture').forEach(pref => pref.classList.remove('selected'));
            document.querySelectorAll('.city-point').forEach(point => point.classList.remove('selected'));
            document.querySelectorAll('.route-line').forEach(line => line.remove());
            document.querySelectorAll('.location-marker').forEach(marker => marker.remove());
            hideInfoPopup();
            
            if (document.getElementById('japanMap').style.display !== 'none') {
                updateJapanMap();
            } else {
                updateDetailedMap();
                if (showRoutes) {
                    drawRoutes();
                }
                drawLocationMarkers();
                if (showShapes && currentRegion) {
                    drawPrefectureShapes(currentRegion);
                }
            }
        }
        
        function updateJapanMap() {
            const mapElement = document.getElementById('japanMap');
            
            travelPlans.forEach((plan, index) => {
                const prefectureElement = document.querySelector(`[data-region="${plan.region}"]`);
                if (prefectureElement) {
                    prefectureElement.classList.add('selected');
                    
                    const marker = document.createElement('div');
                    marker.className = 'travel-marker';
                    marker.style.backgroundColor = getRandomColor(index);
                    
                    marker.style.left = (prefectureElement.offsetLeft + prefectureElement.offsetWidth / 2 - 40) + 'px';
                    marker.style.top = (prefectureElement.offsetTop - 30 - (index * 25)) + 'px';
                    
                    const budgetText = plan.budget ? `Â¥${parseInt(plan.budget).toLocaleString()}` : 'äºˆç®—æœªè¨­å®š';
                    const duration = calculateDuration(plan.startDate, plan.endDate);
                    
                    marker.innerHTML = `
                        <div style="font-size: 10px;">${plan.prefecture}</div>
                        <div style="font-size: 9px;">${budgetText}</div>
                        <div style="font-size: 8px;">${duration}æ—¥é–“</div>
                    `;
                    
                    mapElement.appendChild(marker);
                }
            });
        }
        
        function updateDetailedMap() {
            if (!currentRegion) return;
            
            const mapElement = document.getElementById('detailedMap');
            
            travelPlans.filter(plan => plan.region === currentRegion).forEach((plan, index) => {
                const prefData = prefectureData[currentRegion].find(pref => pref.name === plan.prefecture);
                if (prefData) {
                    const prefPoint = document.querySelector(`[data-prefecture="${plan.prefecture}"]`);
                    if (prefPoint) {
                        prefPoint.classList.add('selected');
                    }
                    
                    const marker = document.createElement('div');
                    marker.className = 'compact-marker';
                    marker.style.backgroundColor = getRandomColor(index);
                    
                    let markerX = prefData.x;
                    let markerY = prefData.y;
                    
                    if (plan.customLocation) {
                        markerX = plan.customLocation.x;
                        markerY = plan.customLocation.y;
                    }
                    
                    marker.style.left = markerX + 'px';
                    marker.style.top = markerY + 'px';
                    
                    const orderBadge = document.createElement('div');
                    orderBadge.className = 'order-badge';
                    orderBadge.textContent = plan.order;
                    marker.appendChild(orderBadge);
                    
                    marker.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showInfoPopup(plan, e.pageX, e.pageY);
                    });
                    
                    mapElement.appendChild(marker);
                }
            });
        }

        function updateTravelList() {
            const listElement = document.getElementById('travelList');
            listElement.innerHTML = '<h3>æ—…è¡Œãƒ—ãƒ©ãƒ³ä¸€è¦§</h3>';
            
            travelPlans.forEach(plan => {
                const item = document.createElement('div');
                item.className = 'travel-item';
                
                const budgetText = plan.budget ? `Â¥${parseInt(plan.budget).toLocaleString()}` : 'äºˆç®—æœªè¨­å®š';
                const transportText = plan.transportation ? transportationNames[plan.transportation] : 'äº¤é€šæ‰‹æ®µæœªè¨­å®š';
                const duration = calculateDuration(plan.startDate, plan.endDate);
                const locationText = plan.specificLocation ? `${plan.specificLocation} (${plan.prefecture})` : plan.prefecture;
                
                item.innerHTML = `
                    <div class="travel-item-header">${plan.order}. ${locationText} (${regionNames[plan.region]}) (${duration}æ—¥é–“)</div>
                    <div class="travel-item-details">
                        ğŸ“… ${plan.startDate} ï½ ${plan.endDate}<br>
                        ğŸ’° ${budgetText}<br>
                        ğŸš— ${transportText}<br>
                        ${plan.activities ? `ğŸ“ ${plan.activities}` : ''}
                    </div>
                `;
                
                listElement.appendChild(item);
            });
        }

        function calculateDuration(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }

        function getRandomColor(index) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#f0932b', '#eb4d4b', '#6c5ce7', '#fd79a8'];
            return colors[index % colors.length];
        }

        function clearMap() {
            if (confirm('ã™ã¹ã¦ã®æ—…è¡Œãƒ—ãƒ©ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                travelPlans = [];
                planCounter = 0;
                updateMap();
                updateTravelList();
            }
        }

        function showJapanMap() {
            document.getElementById('japanMap').style.display = 'block';
            document.getElementById('detailedMap').classList.remove('active');
            currentRegion = null;
            updateMap();
        }
        
        function showDetailedMap(region) {
            currentRegion = region;
            document.getElementById('japanMap').style.display = 'none';
            document.getElementById('detailedMap').classList.add('active');
            
            const regionTitle = document.getElementById('regionTitle');
            regionTitle.textContent = regionNames[region] + ' è©³ç´°åœ°å›³';
            
            const prefecturePointsContainer = document.getElementById('cityPoints');
            prefecturePointsContainer.innerHTML = '';
            
            prefectureData[region].forEach(pref => {
                const point = document.createElement('div');
                point.className = 'city-point';
                point.setAttribute('data-prefecture', pref.name);
                point.style.left = pref.x + 'px';
                point.style.top = pref.y + 'px';
                
                const label = document.createElement('div');
                label.className = 'city-label';
                label.textContent = pref.name;
                label.style.left = pref.x + 'px';
                label.style.top = pref.y + 'px';
                
                point.addEventListener('click', function() {
                    document.getElementById('prefecture').value = pref.name;
                });
                
                prefecturePointsContainer.appendChild(point);
                prefecturePointsContainer.appendChild(label);
            });
            
            updateMap();
            setupClickableArea();
            if (showShapes) {
                drawPrefectureShapes(region);
            }
        }
        
        function drawRoutes() {
            if (!currentRegion) return;
            
            const routeLinesContainer = document.getElementById('routeLines');
            routeLinesContainer.innerHTML = '';
            
            const regionPlans = travelPlans.filter(plan => plan.region === currentRegion).sort((a, b) => a.order - b.order);
            
            for (let i = 0; i < regionPlans.length - 1; i++) {
                const currentPlan = regionPlans[i];
                const nextPlan = regionPlans[i + 1];
                
                let currentX, currentY, nextX, nextY;
                
                if (currentPlan.customLocation) {
                    currentX = currentPlan.customLocation.x;
                    currentY = currentPlan.customLocation.y;
                } else {
                    const currentPrefData = prefectureData[currentRegion].find(pref => pref.name === currentPlan.prefecture);
                    currentX = currentPrefData.x;
                    currentY = currentPrefData.y;
                }
                
                if (nextPlan.customLocation) {
                    nextX = nextPlan.customLocation.x;
                    nextY = nextPlan.customLocation.y;
                } else {
                    const nextPrefData = prefectureData[currentRegion].find(pref => pref.name === nextPlan.prefecture);
                    nextX = nextPrefData.x;
                    nextY = nextPrefData.y;
                }
                
                const line = document.createElement('div');
                line.className = 'route-line';
                
                const deltaX = nextX - currentX;
                const deltaY = nextY - currentY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
                
                line.style.left = currentX + 'px';
                line.style.top = currentY + 'px';
                line.style.width = distance + 'px';
                line.style.transform = `rotate(${angle}deg)`;
                
                line.title = `${currentPlan.specificLocation || currentPlan.prefecture} â†’ ${nextPlan.specificLocation || nextPlan.prefecture}`;
                
                routeLinesContainer.appendChild(line);
            }
        }
        
        function drawLocationMarkers() {
            if (!currentRegion) return;
            
            const markersContainer = document.getElementById('locationMarkers');
            markersContainer.innerHTML = '';
            
            const regionPlans = travelPlans.filter(plan => plan.region === currentRegion);
            
            regionPlans.forEach(plan => {
                if (plan.customLocation) {
                    const marker = document.createElement('div');
                    marker.className = 'location-marker';
                    marker.style.left = plan.customLocation.x + 'px';
                    marker.style.top = plan.customLocation.y + 'px';
                    marker.title = plan.specificLocation || 'æŒ‡å®šå ´æ‰€';
                    markersContainer.appendChild(marker);
                }
            });
        }
        
        function toggleRoutes() {
            showRoutes = !showRoutes;
            const button = document.getElementById('routeToggle');
            button.textContent = showRoutes ? 'çµŒè·¯éè¡¨ç¤º' : 'çµŒè·¯è¡¨ç¤º';
            updateMap();
        }
        
        function setupClickableArea() {
            const clickableArea = document.getElementById('clickableArea');
            if (clickableArea) {
                clickableArea.addEventListener('click', function(e) {
                    if (!currentRegion) return;
                    
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    clickedLocation = { x: x, y: y };
                    
                    const specificLocationInput = document.getElementById('specificLocation');
                    specificLocationInput.value = `åº§æ¨™: (${Math.round(x)}, ${Math.round(y)})`;
                    specificLocationInput.focus();
                });
            }
        }
        
        function drawPrefectureShapes(region) {
            const svg = document.getElementById('prefectureSvg');
            svg.innerHTML = '';
            
            if (prefectureShapes[region]) {
                if (typeof prefectureShapes[region] === 'string') {
                    // å˜ä¸€ã®éƒ½é“åºœçœŒï¼ˆåŒ—æµ·é“ã€æ²–ç¸„ï¼‰
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', prefectureShapes[region]);
                    path.setAttribute('class', 'prefecture-shape');
                    svg.appendChild(path);
                } else {
                    // è¤‡æ•°ã®éƒ½é“åºœçœŒãŒã‚ã‚‹åœ°æ–¹
                    Object.entries(prefectureShapes[region]).forEach(([prefName, pathData]) => {
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        path.setAttribute('d', pathData);
                        path.setAttribute('class', 'prefecture-shape');
                        path.setAttribute('data-prefecture', prefName);
                        
                        // æ—…è¡Œãƒ—ãƒ©ãƒ³ãŒã‚ã‚‹éƒ½é“åºœçœŒã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                        const hasPlans = travelPlans.some(plan => 
                            plan.region === region && 
                            plan.prefecture.includes(prefName.charAt(0).toUpperCase() + prefName.slice(1))
                        );
                        
                        if (hasPlans) {
                            path.classList.add('highlighted');
                        }
                        
                        svg.appendChild(path);
                    });
                }
            }
        }
        
        function toggleShapes() {
            showShapes = !showShapes;
            const button = document.getElementById('shapeToggle');
            button.textContent = showShapes ? 'å¢ƒç•Œç·šéè¡¨ç¤º' : 'å¢ƒç•Œç·šè¡¨ç¤º';
            
            const svg = document.getElementById('prefectureSvg');
            if (showShapes && currentRegion) {
                drawPrefectureShapes(currentRegion);
            } else {
                svg.innerHTML = '';
            }
        }
        
        function showInfoPopup(plan, x, y) {
            const popup = document.getElementById('infoPopup');
            const content = document.getElementById('popupContent');
            
            const budgetText = plan.budget ? `Â¥${parseInt(plan.budget).toLocaleString()}` : 'äºˆç®—æœªè¨­å®š';
            const transportText = plan.transportation ? transportationNames[plan.transportation] : 'äº¤é€šæ‰‹æ®µæœªè¨­å®š';
            const duration = calculateDuration(plan.startDate, plan.endDate);
            const locationText = plan.specificLocation ? plan.specificLocation : plan.prefecture;
            
            content.innerHTML = `
                <h4>${plan.order}. ${locationText}</h4>
                <p><strong>ğŸ“ å ´æ‰€:</strong> ${plan.prefecture}</p>
                <p><strong>ğŸ“… æœŸé–“:</strong> ${plan.startDate} ï½ ${plan.endDate} (${duration}æ—¥é–“)</p>
                <p><strong>ğŸ’° äºˆç®—:</strong> ${budgetText}</p>
                <p><strong>ğŸš— äº¤é€š:</strong> ${transportText}</p>
                ${plan.activities ? `<p><strong>ğŸ“ äºˆå®š:</strong> ${plan.activities}</p>` : ''}
                ${plan.customLocation ? `<p><strong>ğŸ¯ åº§æ¨™:</strong> (${Math.round(plan.customLocation.x)}, ${Math.round(plan.customLocation.y)})</p>` : ''}
            `;
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä½ç½®ã‚’èª¿æ•´
            popup.style.left = Math.min(x - 100, window.innerWidth - 250) + 'px';
            popup.style.top = Math.max(y - 100, 50) + 'px';
            popup.classList.add('show');
        }
        
        function hideInfoPopup() {
            const popup = document.getElementById('infoPopup');
            popup.classList.remove('show');
        }
        
        document.querySelectorAll('.prefecture').forEach(prefecture => {
            prefecture.addEventListener('click', function() {
                const region = this.getAttribute('data-region');
                document.getElementById('region').value = region;
                showDetailedMap(region);
                
                const prefectureSelect = document.getElementById('prefecture');
                prefectureSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                prefectureData[region].forEach(pref => {
                    const option = document.createElement('option');
                    option.value = pref.name;
                    option.textContent = pref.name;
                    prefectureSelect.appendChild(option);
                });
            });
        });
    </script>
</body>
</html>
